<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pit Scouting</title>
  <link rel="stylesheet" href="styles.css">

  <style>
    #qrcode canvas {
      border: 1px solid #000;
    }
  </style>

  <script>
    function generateQRCode(event) {
      event.preventDefault(); // Prevent form submission

      function getSafeValue(value) {
        return (value === null || value === undefined || value === '') ? '[]' : value;
      }

      const formData = {
        teamNumber: document.getElementById("teamNumber").value,
        teamName: document.getElementById("teamName").value,
        driveType: {
          Sweve: document.getElementById("Sweve").checked ? "Sweve" : "",
          Tank: document.getElementById("Tank").checked ? "Tank" : "",
          Mecanum: document.getElementById("Mecanum").checked ? "Mecanum" : ""
        },
        auton: {
          yes: document.getElementById("DYRLIAY").checked ? "Yes" : "",
          no: document.getElementById("DYRLIAN").checked ? "No" : ""
        },
        autonPlan: document.getElementById("Whats_your_Auton_plan").value,
        scoringMethod: {
          Algee: document.getElementById("Algee").checked ? "Algee" : "",
          Coral: document.getElementById("Coral").checked ? "Coral" : ""
        },
        highestCoralLevel: {
          L1: document.getElementById("L1").checked ? "Level 1" : "",
          L2: document.getElementById("L2").checked ? "Level 2" : "",
          L3: document.getElementById("L3").checked ? "Level 3" : "",
          L4: document.getElementById("L4").checked ? "Level 4" : ""
        },
        pickupMethod: {
          Ground: document.getElementById("Ground").checked ? "Ground" : "",
          PS: document.getElementById("PS").checked ? "Player Station" : "",
          BT: document.getElementById("BT").checked ? "Both" : ""
        },
        preferredCoralLevel: {
          PL1: document.getElementById("PL1").checked ? "Level 1" : "",
          PL2: document.getElementById("PL2").checked ? "Level 2" : "",
          PL3: document.getElementById("PL3").checked ? "Level 3" : "",
          PL4: document.getElementById("PL4").checked ? "Level 4" : ""
        },
        shootProcessAlgee: {
          Both: document.getElementById("Both").checked ? "Both" : "",
          Shoot: document.getElementById("Shoot").checked ? "Shoot" : "",
          Process: document.getElementById("Process").checked ? "Process" : "",
          Nither: document.getElementById("Nither").checked ? "Nither" : ""
        },
        comments: document.getElementById("Comments").value
      };

      // Convert form data into CSV format
      const csvData = [
        `${formData.teamNumber},${formData.teamName},${formData.driveType.Sweve},${formData.driveType.Tank},${formData.driveType.Mecanum},${formData.auton.yes},${formData.auton.no},${formData.autonPlan},${formData.scoringMethod.Algee},${formData.scoringMethod.Coral},${Object.values(formData.highestCoralLevel).join(", ")},${Object.values(formData.pickupMethod).join(", ")},${Object.values(formData.preferredCoralLevel).join(", ")},${Object.values(formData.shootProcessAlgee).join(", ")},${formData.comments}`   
      ].join("\n");

      document.getElementById("csvData").value = csvData;

      // Clear previous QR code (if any)
      const qrCodeContainer = document.getElementById("qrcode");
      qrCodeContainer.innerHTML = ""; 

      // Generate QR Code
      const matrix = generateQRCodeMatrix(csvData);
      renderQRCode(matrix, 'qrcode');
    }

    function generateQRCodeMatrix(data) {
      const binaryData = encodeDataToBinary(data);
      const matrixSize = 21; // QR version 1 size
      const matrix = createEmptyMatrix(matrixSize);

      let index = 0;
      for (let row = 0; row < matrixSize; row++) {
        for (let col = 0; col < matrixSize; col++) {
          if (index < binaryData.length) {
            matrix[row][col] = binaryData[index] === '1' ? 1 : 0;
            index++;
          }
        }
      }

      return matrix;
    }

    function createEmptyMatrix(size) {
      const matrix = [];
      for (let i = 0; i < size; i++) {
        matrix.push(new Array(size).fill(0));
      }
      return matrix;
    }

    function encodeDataToBinary(data) {
      let binaryString = '';
      for (let i = 0; i < data.length; i++) {
        binaryString += data.charCodeAt(i).toString(2).padStart(8, '0');
      }
      return binaryString;
    }

    function renderQRCode(matrix, containerId) {
      const container = document.getElementById(containerId);
      const size = matrix.length;
      const squareSize = 10; // Size of each square

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = size * squareSize;
      canvas.height = size * squareSize;

      for (let row = 0; row < size; row++) {
        for (let col = 0; col < size; col++) {
          context.fillStyle = matrix[row][col] === 1 ? 'black' : 'white';
          context.fillRect(col * squareSize, row * squareSize, squareSize, squareSize);
        }
      }

      container.appendChild(canvas);
    }

    function copyToClipboard(text) {
      const tempTextArea = document.createElement('textarea');
      tempTextArea.value = text;
      document.body.appendChild(tempTextArea);
      tempTextArea.select();
      document.execCommand('copy');
      document.body.removeChild(tempTextArea);
    }
  </script>
</head>
<body>
  <h1>MP Reefscape Pit Scouting</h1>

  <form id="MP Pit Scouting" onsubmit="generateQRCode(event)">
    <label for="teamNumber">Team Number:</label>
    <input type="number" id="teamNumber" name="teamNumber"><br><br>

    <label for="teamName">Team Name:</label>
    <input type="text" id="teamName" name="teamName"><br><br>

    <!-- Add the other form fields as you had before -->

    <button type="submit">Generate QR Code</button>
  </form>

  <div id="qrcode"></div>
  <input type="text" id="csvData" readonly>
  <button onclick="copyToClipboard(document.getElementById('csvData').value)">Copy CSV Data</button>
</body>
</html>
